<script>
    // Initialize Supabase
    const supabaseUrl = 'https://aiqnodafwmzhwsfunvco.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpcW5vZGFmd216aHdzZnVudmNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjE4MTcsImV4cCI6MjA3NTA5NzgxN30.OEZloiLjXFdVdgZY6cxqfDlihxRVj36K1N9yjJZzLv8';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    let userId = null;
    let userData = null;
    
    // Check authentication
    supabase.auth.getSession().then(({ data: { session } }) => {
        console.log('Session check:', session);
        if (!session) {
            window.location.href = 'login.html';
        } else {
            userId = session.user.id;
            console.log('User ID:', userId);
            loadUserData();
        }
    }).catch(error => {
        console.error('Auth error:', error);
        // Fallback - check localStorage
        const storedUser = localStorage.getItem('earnzy_user');
        if (storedUser) {
            userData = JSON.parse(storedUser);
            updateUIWithFallbackData();
        }
    });
    
    // Load user data with error handling
    async function loadUserData() {
        try {
            console.log('Loading user data for:', userId);
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();
            
            if (error) {
                console.error('Database error:', error);
                // Use fallback data
                useFallbackData();
                return;
            }
            
            console.log('User data loaded:', data);
            userData = data;
            
            // Update UI
            document.getElementById('userEmail').textContent = data.email;
            document.getElementById('referralCode').textContent = data.referral_code || 'EARNZY123';
            document.getElementById('totalCoins').textContent = data.total_coins || 100;
            document.getElementById('dailyStreak').textContent = data.daily_streak || 0;
            
            // Store in localStorage as backup
            localStorage.setItem('earnzy_user', JSON.stringify(data));
            
        } catch (error) {
            console.error('Error loading user data:', error);
            useFallbackData();
        }
    }
    
    // Fallback data when database fails
    function useFallbackData() {
        const fallbackData = {
            email: 'user@earnzy.com',
            referral_code: 'EARNZY123',
            total_coins: 100,
            daily_streak: 0
        };
        
        document.getElementById('userEmail').textContent = fallbackData.email;
        document.getElementById('referralCode').textContent = fallbackData.referral_code;
        document.getElementById('totalCoins').textContent = fallbackData.total_coins;
        document.getElementById('dailyStreak').textContent = fallbackData.daily_streak;
    }
    
    // Update UI with fallback data
    function updateUIWithFallbackData() {
        if (userData) {
            document.getElementById('userEmail').textContent = userData.email;
            document.getElementById('referralCode').textContent = userData.referral_code;
            document.getElementById('totalCoins').textContent = userData.total_coins;
            document.getElementById('dailyStreak').textContent = userData.daily_streak;
        }
    }
    
    // Simple coin add function (local storage based)
    function addCoinsLocal(coins, type) {
        let user = JSON.parse(localStorage.getItem('earnzy_user') || '{}');
        user.total_coins = (user.total_coins || 100) + coins;
        localStorage.setItem('earnzy_user', JSON.stringify(user));
        
        // Update UI
        document.getElementById('totalCoins').textContent = user.total_coins;
        
        // Show success message
        showMessage(`+${coins} coins added!`, 'success');
        
        // Try to update database in background
        updateDatabaseInBackground(coins, type);
    }
    
    // Update database in background
    async function updateDatabaseInBackground(coins, type) {
        try {
            if (userId) {
                const { data: userData } = await supabase
                    .from('users')
                    .select('total_coins')
                    .eq('id', userId)
                    .single();
                
                if (userData) {
                    await supabase
                        .from('users')
                        .update({ total_coins: userData.total_coins + coins })
                        .eq('id', userId);
                }
            }
        } catch (error) {
            console.log('Background update failed, using local storage');
        }
    }
    
    // Show message
    function showMessage(message, type) {
        // Simple message display
        alert(message);
    }
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        localStorage.removeItem('earnzy_user');
        window.location.href = 'login.html';
    });
    
    // Bottom nav active state
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
        });
    });
</script>
